<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tamagotchi üê£ | Solana Devnet - Full</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .devnet-badge {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            display: inline-block;
            margin-top: 5px;
            font-weight: bold;
        }

        .wallet-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .connect-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .connect-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .wallet-connected {
            color: white;
            font-size: 0.9em;
        }

        .pet-display {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .pet-sprite {
            font-size: 120px;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
        }

        .pet-sprite:hover {
            transform: scale(1.1);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .pet-name {
            font-size: 1.5em;
            color: #667eea;
            margin-top: 15px;
            font-weight: bold;
        }

        .pet-level {
            font-size: 1em;
            color: #764ba2;
            margin-top: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
        }

        .stat-bar-container {
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .stat-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: white;
            font-weight: bold;
        }

        .stat-bar.health { background: linear-gradient(90deg, #ff6b6b, #ee5a6f); }
        .stat-bar.hunger { background: linear-gradient(90deg, #ffa502, #ff6348); }
        .stat-bar.happiness { background: linear-gradient(90deg, #ffd32a, #ffb142); }
        .stat-bar.energy { background: linear-gradient(90deg, #48dbfb, #0abde3); }

        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .token-cost {
            font-size: 0.7em;
            opacity: 0.8;
            margin-top: 3px;
        }

        .info-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            font-weight: bold;
            color: #667eea;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 25px;
            font-size: 1.3em;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s;
            width: 100%;
        }

        .start-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 15px;
            height: 15px;
            border: 3px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üê£ Crypto Tamagotchi</h1>
            <div class="devnet-badge">üéÆ DEVNET - FULL VERSION</div>
            <p style="color: #764ba2; margin-top: 10px;">–°–æ–∑–¥–∞–≤–∞–π –∏ –∏–≥—Ä–∞–π!</p>
            <p style="color: #4caf50; margin-top: 5px; font-size: 0.9em;">‚ú® –í—Å–µ –≤ –±–ª–æ–∫—á–µ–π–Ω–µ!</p>
        </div>

        <div class="wallet-section" id="walletSection">
            <button class="connect-btn" id="connectWalletBtn" onclick="connectWallet()">
                üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫ (Devnet)
            </button>
            <div id="walletInfo" class="wallet-connected" style="display: none;">
                <div id="walletAddress"></div>
                <div id="solBalance" style="margin-top: 10px; font-size: 0.9em;">SOL: ...</div>
                <div id="tamaBalance" style="margin-top: 5px; font-size: 0.9em; color: #ffd700;">ü™ô TAMA: ...</div>
                <button class="connect-btn" onclick="requestAirdrop()" style="margin-top: 10px; background: #4caf50;">
                    üí∞ –ü–æ–ª—É—á–∏—Ç—å Devnet SOL
                </button>
                <button class="connect-btn" onclick="disconnectWallet()" style="margin-top: 10px; background: #ff6b6b;">
                    üîå –û—Ç–∫–ª—é—á–∏—Ç—å
                </button>
            </div>
        </div>

        <div id="startScreen" class="start-screen" style="text-align: center;">
            <div class="pet-display">
                <div style="font-size: 100px;">ü•ö</div>
                <p style="margin-top: 20px; color: #667eea; font-size: 1.2em;">
                    –ù–∞—á–Ω–∏ —Å–≤–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ!
                </p>
            </div>
            <button class="start-btn" id="createPetBtn" onclick="createPet()" disabled>
                üéÆ –ó–∞–≤–µ—Å—Ç–∏ –ø–∏—Ç–æ–º—Ü–∞
            </button>
            <p style="text-align: center; margin-top: 15px; color: #4CAF50; font-size: 0.9em; font-weight: bold;">
                ‚ú® –°–æ–∑–¥–∞–Ω–∏–µ –ë–ï–°–ü–õ–ê–¢–ù–û! –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∂–µ!
            </p>
        </div>

        <div id="gameScreen" style="display: none;">
            <div class="pet-display" id="petDisplay">
                <div class="pet-sprite" id="petSprite" onclick="petClick()">üê£</div>
                <div class="pet-name" id="petName">–ü–∏—Ç–æ–º–µ—Ü</div>
                <div class="pet-level" id="petLevel">–£—Ä–æ–≤–µ–Ω—å 1</div>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</div>
                    <div class="stat-bar-container">
                        <div class="stat-bar health" id="healthBar">100%</div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">üçñ –ì–æ–ª–æ–¥</div>
                    <div class="stat-bar-container">
                        <div class="stat-bar hunger" id="hungerBar">100%</div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">üòä –°—á–∞—Å—Ç—å–µ</div>
                    <div class="stat-bar-container">
                        <div class="stat-bar happiness" id="happinessBar">100%</div>
                    </div>
                </div>
                <div class="stat">
                    <div class="stat-label">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
                    <div class="stat-bar-container">
                        <div class="stat-bar energy" id="energyBar">100%</div>
                    </div>
                </div>
            </div>

            <!-- –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div id="realtimeInfo" style="margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 15px; border: 2px solid #ff9800;">
                <div style="text-align: center; font-weight: bold; color: #e65100; margin-bottom: 8px; font-size: 0.95em;">
                    ‚è∞ –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
                </div>
                <div id="decayTimer" style="text-align: center; font-size: 0.9em; color: #f57c00; margin-bottom: 5px;">
                    –°–ª–µ–¥—É—é—â–∏–π decay —á–µ—Ä–µ–∑: --
                </div>
                <div id="deathPrediction" style="text-align: center; font-size: 0.85em; color: #d84315; display: none;">
                    üíÄ –ü—Ä–æ–≥–Ω–æ–∑: --
                </div>
                <div id="recommendations" style="margin-top: 8px; display: none;">
                    <div style="text-align: center; font-size: 0.85em; color: #e65100; font-weight: bold; margin-bottom: 5px;">
                        üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
                    </div>
                    <div id="recommendationsList" style="font-size: 0.8em; color: #f57c00;"></div>
                </div>
            </div>

            <div class="actions">
                <button class="action-btn" onclick="feedPet()" id="feedBtn">üçñ –ö–æ—Ä–º–∏—Ç—å<div class="token-cost">5 TAMA</div></button>
                <button class="action-btn" onclick="playWithPet()" id="playBtn">üéÆ –ò–≥—Ä–∞—Ç—å<div class="token-cost">3 TAMA</div></button>
                <button class="action-btn" onclick="healPet()" id="healBtn">üíä –õ–µ—á–∏—Ç—å<div class="token-cost">8 TAMA</div></button>
                <button class="action-btn" onclick="restPet()" id="restBtn">üò¥ –û—Ç–¥–æ—Ö–Ω—É—Ç—å<div class="token-cost">2 TAMA</div></button>
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="action-btn" onclick="manualUpdateDecay()" id="decayBtn" style="width: 100%; background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –°—Ç–∞—Ç—ã (–ë–ï–°–ü–õ–ê–¢–ù–û!)
                </button>
                <div style="margin-top: 10px; padding: 10px; background: rgba(76,175,80,0.1); border-radius: 10px; font-size: 0.85em; color: #2e7d32;">
                    ‚ú® <strong>AUTO DECAY –≤–∫–ª—é—á–µ–Ω!</strong> –°—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏.
                </div>
            </div>

            <div class="info-panel" id="petInfoPanel" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border: 2px solid #667eea;">
                <div style="text-align: center; font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">
                    üê£ –ü–∏—Ç–æ–º–µ—Ü –∏–∑ Blockchain
                </div>
                <div class="info-row">
                    <span class="info-label">üÜî Pet ID:</span>
                    <span class="info-value" id="petId">#????</span>
                </div>
                <div class="info-row">
                    <span class="info-label">üß¨ DNA:</span>
                    <span class="info-value" id="petDna">...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">‚ú® –†–µ–¥–∫–æ—Å—Ç—å:</span>
                    <span class="info-value" id="petRarity">‚≠ê</span>
                </div>
                <div class="info-row">
                    <span class="info-label">üìä –£—Ä–æ–≤–µ–Ω—å:</span>
                    <span class="info-value" id="petLevelInfo">1</span>
                </div>
                <div class="info-row">
                    <span class="info-label">‚≠ê –û–ø—ã—Ç:</span>
                    <span class="info-value" id="petExp">0</span>
                </div>
                <button class="action-btn" onclick="refreshPet()" style="width: 100%; margin-top: 10px;">
                    üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <button class="action-btn" onclick="closePetAccount()" id="closeBtn" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); display: none;">
                    üíÄ –ó–∞–∫—Ä—ã—Ç—å –∞–∫–∫–∞—É–Ω—Ç (–≤–µ—Ä–Ω—É—Ç—å rent)
                </button>
            </div>

            <div id="explorerLink" style="text-align: center; margin-top: 10px;">
                <a href="#" id="petAccountLink" target="_blank" style="color: #667eea; text-decoration: none; font-size: 0.9em;">
                    üîç –°–º–æ—Ç—Ä–µ—Ç—å –≤ Explorer
                </a>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Solana Web3.js -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

    <script>
        // üéØ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
        const PROGRAM_ID = 'uY5hZR2uYzkquJDuDkFBj29tfzZRPE96BBTHYGaYnwX';
        const RPC_URL = 'https://api.devnet.solana.com';
        const TOKEN_MINT = '74KGR9mdiiiqVW9QCnFmZz8cyj39ZoCaKexrSxF8fpQD'; // TAMA —Ç–æ–∫–µ–Ω
        const TOKEN_PROGRAM_ID = 'TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA';
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ!)
        var connection = null;
        var wallet = null;
        var petPubkey = null;
        
        // –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–∏—Ç–æ–º—Ü–∞ –∏–∑ blockchain
        var realPetData = null;
        var realtimeUpdateInterval = null;
        
        // Buffer polyfill –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
        function stringToBytes(str) {
            return new TextEncoder().encode(str);
        }

        // –í—ã—á–∏—Å–ª–∏—Ç—å Anchor discriminator –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        async function getInstructionDiscriminator(name) {
            const preimage = `global:${name}`;
            const data = new TextEncoder().encode(preimage);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = new Uint8Array(hashBuffer);
            return hashArray.slice(0, 8);
        }

        // –ü–æ–ª—É—á–∏—Ç—å Associated Token Account
        async function getAssociatedTokenAddress(mint, owner) {
            const ASSOCIATED_TOKEN_PROGRAM_ID = new window.solanaWeb3.PublicKey(
                'ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL'
            );
            
            const [address] = await window.solanaWeb3.PublicKey.findProgramAddress(
                [
                    owner.toBytes(),
                    new window.solanaWeb3.PublicKey(TOKEN_PROGRAM_ID).toBytes(),
                    mint.toBytes()
                ],
                ASSOCIATED_TOKEN_PROGRAM_ID
            );
            
            return address;
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å Token Account
        async function getOrCreateTokenAccount() {
            if (!wallet) return null;
            
            try {
                const mintPubkey = new window.solanaWeb3.PublicKey(TOKEN_MINT);
                const ata = await getAssociatedTokenAddress(mintPubkey, wallet.publicKey);
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏
                const accountInfo = await connection.getAccountInfo(ata);
                
                if (!accountInfo) {
                    showNotification("‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ—Ç TAMA —Ç–æ–∫–µ–Ω–æ–≤! –ù—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å airdrop.");
                    return null;
                }
                
                return ata;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ token account:', err);
                return null;
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –±–∞–ª–∞–Ω—Å TAMA —Ç–æ–∫–µ–Ω–æ–≤
        async function getTokenBalance() {
            if (!wallet) return 0;
            
            try {
                const tokenAccount = await getOrCreateTokenAccount();
                if (!tokenAccount) return 0;
                
                const balance = await connection.getTokenAccountBalance(tokenAccount);
                return balance.value.uiAmount || 0;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Ç–æ–∫–µ–Ω–æ–≤:', err);
                return 0;
            }
        }

        // –†–µ–¥–∫–æ—Å—Ç–∏
        const RARITY_NAMES = ['Common', 'Uncommon', 'Rare', 'Epic', 'Legendary'];
        const RARITY_STARS = ['‚≠ê', '‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê‚≠ê', '‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê'];
        
        // –í–∏–¥—ã –ø–∏—Ç–æ–º—Ü–µ–≤
        const SPECIES_EMOJI = ['üê£', 'üê±', 'üê∂', 'üêâ', 'ü¶ä', 'üêª', 'üê∞', 'üêº', 'ü¶ù', 'üêπ'];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            connection = new window.solanaWeb3.Connection(RPC_URL, 'confirmed');
            console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Solana Devnet');
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        async function connectWallet() {
            try {
                if (!window.solana || !window.solana.isPhantom) {
                    showNotification("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Phantom –∫–æ—à–µ–ª–µ–∫!");
                    window.open('https://phantom.app/', '_blank');
                    return;
                }

                const resp = await window.solana.connect();
                wallet = window.solana;
                
                const publicKey = resp.publicKey.toString();
                
                document.getElementById('connectWalletBtn').style.display = 'none';
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletAddress').innerHTML = `‚úÖ ${publicKey.slice(0, 4)}...${publicKey.slice(-4)}`;
                
                // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                await updateBalance();
                
                // –í–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
                document.getElementById('createPetBtn').disabled = false;
                
                showNotification("‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω!");
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–∏—Ç–æ–º–µ—Ü
                await checkExistingPet();
                
            } catch (err) {
                showNotification("‚ùå –û—à–∏–±–∫–∞: " + err.message);
                console.error(err);
            }
        }

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
        async function disconnectWallet() {
            try {
                if (wallet) {
                    await wallet.disconnect();
                }
                wallet = null;
                petPubkey = null;
                
                document.getElementById('connectWalletBtn').style.display = 'block';
                document.getElementById('walletInfo').style.display = 'none';
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('startScreen').style.display = 'block';
                document.getElementById('createPetBtn').disabled = true;
                
                showNotification("üëã –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω!");
            } catch (err) {
                console.error(err);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å SOL –∏ TAMA
        async function updateBalance() {
            if (!wallet) return;
            
            try {
                // SOL –±–∞–ª–∞–Ω—Å
                const balance = await connection.getBalance(wallet.publicKey);
                const solBalance = (balance / window.solanaWeb3.LAMPORTS_PER_SOL).toFixed(4);
                document.getElementById('solBalance').textContent = `SOL: ${solBalance}`;
                
                // TAMA –±–∞–ª–∞–Ω—Å
                const tamaBalance = await getTokenBalance();
                document.getElementById('tamaBalance').textContent = `ü™ô TAMA: ${tamaBalance.toFixed(2)}`;
                
                // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                if (balance < 10000000) { // < 0.01 SOL
                    showNotification("‚ö†Ô∏è –ù–∏–∑–∫–∏–π –±–∞–ª–∞–Ω—Å SOL!");
                }
                
                if (tamaBalance < 10) {
                    showNotification(`‚ö†Ô∏è –ù–∏–∑–∫–∏–π –±–∞–ª–∞–Ω—Å TAMA! –£ –≤–∞—Å: ${tamaBalance.toFixed(2)}`);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞:', err);
            }
        }

        // –ó–∞–ø—Ä–æ—Å–∏—Ç—å airdrop SOL
        async function requestAirdrop() {
            if (!wallet) return;
            
            try {
                showNotification("üí∞ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é 1 SOL... <div class='loading'></div>");
                
                const signature = await connection.requestAirdrop(
                    wallet.publicKey,
                    1 * window.solanaWeb3.LAMPORTS_PER_SOL
                );
                
                showNotification("‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ airdrop...");
                
                await connection.confirmTransaction(signature, 'confirmed');
                
                showNotification("‚úÖ –ü–æ–ª—É—á–µ–Ω–æ 1 SOL!");
                
                // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                await updateBalance();
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ airdrop:', err);
                
                if (err.message.includes('429')) {
                    showNotification("‚ö†Ô∏è –õ–∏–º–∏—Ç airdrop! –ü–æ–ø—Ä–æ–±—É–π —á–µ—Ä–µ–∑ Phantom –∏–ª–∏ https://faucet.solana.com/");
                } else {
                    showNotification("‚ùå –û—à–∏–±–∫–∞ airdrop: " + err.message);
                }
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å PDA –ø–∏—Ç–æ–º—Ü–∞
        async function getPetPda(walletPubkey) {
            const programId = new window.solanaWeb3.PublicKey(PROGRAM_ID);
            const seeds = [
                stringToBytes("pet"),
                walletPubkey.toBytes()
            ];
            
            const [pda, bump] = await window.solanaWeb3.PublicKey.findProgramAddress(
                seeds,
                programId
            );
            
            return [pda, bump];
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞
        async function checkExistingPet() {
            try {
                const [petPda] = await getPetPda(wallet.publicKey);
                petPubkey = petPda;
                
                console.log('üîç –ò—â—É –ø–∏—Ç–æ–º—Ü–∞ –ø–æ –∞–¥—Ä–µ—Å—É:', petPda.toString());
                
                const accountInfo = await connection.getAccountInfo(petPda);
                
                if (accountInfo && accountInfo.data) {
                    console.log('‚úÖ –ü–∏—Ç–æ–º–µ—Ü –Ω–∞–π–¥–µ–Ω!');
                    const pet = deserializePet(accountInfo.data);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Å—Ç–∞—Ç–æ–≤
                    realPetData = pet;
                    
                    document.getElementById('startScreen').style.display = 'none';
                    document.getElementById('gameScreen').style.display = 'block';
                    updateDisplay(pet);
                    
                    // –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ Explorer
                    document.getElementById('petAccountLink').href = 
                        `https://explorer.solana.com/address/${petPda.toString()}?cluster=devnet`;
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π!
                    startRealtimeUpdates();
                    
                    showNotification("üéâ –í–∞—à –ø–∏—Ç–æ–º–µ—Ü –Ω–∞–π–¥–µ–Ω!");
                } else {
                    console.log('‚ÑπÔ∏è –ü–∏—Ç–æ–º–µ—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω - –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å!');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∏—Ç–æ–º—Ü–∞:', err);
            }
        }

        // –°–æ–∑–¥–∞—Ç—å –ø–∏—Ç–æ–º—Ü–∞
        async function createPet() {
            if (!wallet) {
                showNotification("‚ùå –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫!");
                return;
            }

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, –º–æ–∂–µ—Ç —É–∂–µ –µ—Å—Ç—å?
                const [petPda] = await getPetPda(wallet.publicKey);
                const existingAccount = await connection.getAccountInfo(petPda);
                
                if (existingAccount) {
                    showNotification("‚ÑπÔ∏è –ü–∏—Ç–æ–º–µ—Ü —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –ü–æ–∫–∞–∑—ã–≤–∞—é...");
                    await checkExistingPet();
                    return;
                }
                
                showNotification("üê£ –°–æ–∑–¥–∞—é –ø–∏—Ç–æ–º—Ü–∞... <div class='loading'></div>");
                document.getElementById('createPetBtn').disabled = true;

                // petPda —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω –≤—ã—à–µ
                petPubkey = petPda;

                // –°–æ–∑–¥–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                const programId = new window.solanaWeb3.PublicKey(PROGRAM_ID);
                
                // –í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π discriminator –¥–ª—è create_pet
                const discriminator = await getInstructionDiscriminator('create_pet');
                console.log('Create Pet discriminator:', Array.from(discriminator));
                
                const data = discriminator;

                const keys = [
                    { pubkey: petPda, isSigner: false, isWritable: true },
                    { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
                    { pubkey: window.solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
                ];

                const instruction = new window.solanaWeb3.TransactionInstruction({
                    keys,
                    programId,
                    data,
                });

                const transaction = new window.solanaWeb3.Transaction().add(instruction);
                transaction.feePayer = wallet.publicKey;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                // –ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                const signed = await wallet.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signed.serialize());
                
                showNotification("‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ...");
                
                await connection.confirmTransaction(signature, 'confirmed');
                
                console.log('‚úÖ –ü–∏—Ç–æ–º–µ—Ü —Å–æ–∑–¥–∞–Ω! TX:', signature);
                showNotification("üéâ –ü–∏—Ç–æ–º–µ—Ü —Å–æ–∑–¥–∞–Ω!");

                // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å
                await updateBalance();

                // –ü–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                await new Promise(resolve => setTimeout(resolve, 1000));
                await checkExistingPet();
                
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:', err);
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ø–∏—Ç–æ–º–µ—Ü —É–∂–µ —Å–æ–∑–¥–∞–Ω?
                if (err.message.includes('already been processed') || err.message.includes('already exists')) {
                    showNotification("‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–∏—Ç–æ–º—Ü–∞...");
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await checkExistingPet();
                } else {
                    showNotification("‚ùå –û—à–∏–±–∫–∞: " + err.message);
                    document.getElementById('createPetBtn').disabled = false;
                }
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å decay (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤)
        async function updateDecay(silent = true) {
            if (!wallet || !petPubkey) return;
            
            try {
                const programId = new window.solanaWeb3.PublicKey(PROGRAM_ID);
                const discriminator = await getInstructionDiscriminator('update_decay');
                
                const keys = [
                    { pubkey: petPubkey, isSigner: false, isWritable: true },
                ];

                const instruction = new window.solanaWeb3.TransactionInstruction({
                    keys,
                    programId,
                    data: discriminator,
                });

                const transaction = new window.solanaWeb3.Transaction().add(instruction);
                transaction.feePayer = wallet.publicKey;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                const signed = await wallet.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signed.serialize());
                
                await connection.confirmTransaction(signature, 'confirmed');
                
                console.log('‚úÖ Decay updated:', signature);
                await refreshPet();
                
                if (!silent) {
                    showNotification("‚úÖ Decay –æ–±–Ω–æ–≤–ª—ë–Ω!");
                }
                
            } catch (err) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É "already processed" –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤
                if (err.message.includes('already been processed') && silent) {
                    console.log('‚ÑπÔ∏è Decay —É–∂–µ –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–µ–¥–∞–≤–Ω–æ');
                } else if (!silent) {
                    showNotification("‚ùå –û—à–∏–±–∫–∞ decay: " + err.message);
                    console.error('–û—à–∏–±–∫–∞ update_decay:', err);
                }
            }
        }

        // –†—É—á–Ω–æ–π –≤—ã–∑–æ–≤ decay —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º
        async function manualUpdateDecay() {
            showNotification("‚è∞ –û–±–Ω–æ–≤–ª—è—é decay...");
            await updateDecay(false); // –Ω–µ silent, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            await refreshPet();
        }

        // –ö–æ—Ä–º–∏—Ç—å –ø–∏—Ç–æ–º—Ü–∞
        async function feedPet() {
            await performAction('feedPet', 'üçñ –ö–æ—Ä–º–ª—é...', '‚úÖ –ü–æ–∫–æ—Ä–º–ª–µ–Ω!');
        }

        // –ò–≥—Ä–∞—Ç—å
        async function playWithPet() {
            await performAction('playWithPet', 'üéÆ –ò–≥—Ä–∞—é...', '‚úÖ –ü–æ–∏–≥—Ä–∞–ª–∏!');
        }

        // –õ–µ—á–∏—Ç—å
        async function healPet() {
            await performAction('healPet', 'üíä –õ–µ—á—É...', '‚úÖ –í—ã–ª–µ—á–µ–Ω!');
        }

        // –û—Ç–¥—ã—Ö
        async function restPet() {
            await performAction('restPet', 'üò¥ –û—Ç–¥—ã—Ö–∞—é...', '‚úÖ –û—Ç–¥–æ—Ö–Ω—É–ª!');
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
        async function performAction(actionName, loadingMsg, successMsg) {
            if (!wallet || !petPubkey) return;
            
            try {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                await new Promise(resolve => setTimeout(resolve, 500));
                
                showNotification(loadingMsg);
                disableButtons();

                // –ü–æ–ª—É—á–∏—Ç—å token account
                const tokenAccount = await getOrCreateTokenAccount();
                if (!tokenAccount) {
                    showNotification("‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç–µ TAMA —Ç–æ–∫–µ–Ω—ã!");
                    enableButtons();
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
                const tokenBalance = await getTokenBalance();
                console.log(`üí∞ TAMA –±–∞–ª–∞–Ω—Å: ${tokenBalance}`);
                
                if (tokenBalance < 1) {
                    showNotification("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TAMA —Ç–æ–∫–µ–Ω–æ–≤!");
                    enableButtons();
                    return;
                }

                const programId = new window.solanaWeb3.PublicKey(PROGRAM_ID);
                const tokenMintPubkey = new window.solanaWeb3.PublicKey(TOKEN_MINT);
                const tokenProgramPubkey = new window.solanaWeb3.PublicKey(TOKEN_PROGRAM_ID);
                
                // –í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π discriminator
                const functionNames = {
                    feedPet: 'feed_pet',
                    playWithPet: 'play_with_pet',
                    healPet: 'heal_pet',
                    restPet: 'rest_pet'
                };
                
                const discriminator = await getInstructionDiscriminator(functionNames[actionName]);
                console.log(`${actionName} discriminator:`, Array.from(discriminator));
                
                const data = discriminator;

                // –í–°–ï –∞–∫–∫–∞—É–Ω—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç
                const keys = [
                    { pubkey: petPubkey, isSigner: false, isWritable: true },
                    { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
                    { pubkey: tokenAccount, isSigner: false, isWritable: true }, // user_token_account
                    { pubkey: tokenMintPubkey, isSigner: false, isWritable: true }, // token_mint
                    { pubkey: tokenProgramPubkey, isSigner: false, isWritable: false }, // token_program
                ];

                const instruction = new window.solanaWeb3.TransactionInstruction({
                    keys,
                    programId,
                    data,
                });

                const transaction = new window.solanaWeb3.Transaction().add(instruction);
                transaction.feePayer = wallet.publicKey;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                const signed = await wallet.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signed.serialize());
                
                await connection.confirmTransaction(signature, 'confirmed');
                
                console.log(`‚úÖ ${actionName} TX:`, signature);
                showNotification(successMsg);

                // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å –∏ –¥–∞–Ω–Ω—ã–µ
                await updateBalance();
                await new Promise(resolve => setTimeout(resolve, 500));
                await refreshPet();
                
            } catch (err) {
                console.error(`–û—à–∏–±–∫–∞ ${actionName}:`, err);
                
                // –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ - —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º
                if (err.message.includes('already been processed')) {
                    showNotification("‚è≥ –û–±–Ω–æ–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ...");
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    await refreshPet();
                    showNotification(successMsg + " (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)");
                } else {
                    showNotification("‚ùå –û—à–∏–±–∫–∞: " + err.message);
                }
            } finally {
                enableButtons();
            }
        }

        function disableButtons() {
            ['feedBtn', 'playBtn', 'healBtn', 'restBtn'].forEach(id => {
                document.getElementById(id).disabled = true;
            });
        }

        function enableButtons() {
            ['feedBtn', 'playBtn', 'healBtn', 'restBtn'].forEach(id => {
                document.getElementById(id).disabled = false;
            });
        }

        // –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–∞
        function deserializePet(data) {
            let offset = 8;
            
            const owner = new window.solanaWeb3.PublicKey(data.slice(offset, offset + 32));
            offset += 32;
            
            const dna = readU64LE(data, offset);
            offset += 8;
            
            const petId = readU32LE(data, offset);
            offset += 4;
            
            const species = data[offset];
            offset += 1;
            
            const accessory = data[offset];
            offset += 1;
            
            const background = data[offset];
            offset += 1;
            
            const rarity = data[offset];
            offset += 1;
            
            const level = data[offset];
            offset += 1;
            
            const experience = readU16LE(data, offset);
            offset += 2;
            
            const health = data[offset];
            offset += 1;
            
            const hunger = data[offset];
            offset += 1;
            
            const happiness = data[offset];
            offset += 1;
            
            const energy = data[offset];
            offset += 1;
            
            const age = readU32LE(data, offset);
            offset += 4;
            
            const birthTime = readI64LE(data, offset);
            offset += 8;
            
            const lastActionTime = readI64LE(data, offset);
            offset += 8;
            
            const lastDecayTime = readI64LE(data, offset);
            offset += 8;
            
            const actionsCount = readU32LE(data, offset);
            offset += 4;
            
            const isAlive = data[offset] !== 0;
            
            return {
                owner, dna, petId, species, accessory, background, rarity, level,
                experience, health, hunger, happiness, energy, age, 
                birthTime, lastActionTime, lastDecayTime, actionsCount, isAlive
            };
        }

        function readU32LE(buffer, offset) {
            return buffer[offset] + (buffer[offset + 1] << 8) + 
                   (buffer[offset + 2] << 16) + (buffer[offset + 3] << 24);
        }

        function readU16LE(buffer, offset) {
            return buffer[offset] + (buffer[offset + 1] << 8);
        }

        function readU64LE(buffer, offset) {
            const low = readU32LE(buffer, offset);
            const high = readU32LE(buffer, offset + 4);
            return low + high * 4294967296;
        }

        function readI64LE(buffer, offset) {
            const low = readU32LE(buffer, offset);
            const high = readU32LE(buffer, offset + 4);
            // Unix timestamp –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            return low + high * 4294967296;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        function updateDisplay(pet) {
            const species = SPECIES_EMOJI[pet.species] || 'üê£';
            document.getElementById('petSprite').textContent = pet.isAlive ? species : 'üíÄ';
            document.getElementById('petName').textContent = pet.isAlive ? `–ü–∏—Ç–æ–º–µ—Ü #${pet.petId}` : `üíÄ –ü–∏—Ç–æ–º–µ—Ü –º–µ—Ä—Ç–≤ #${pet.petId}`;
            document.getElementById('petLevel').textContent = `–£—Ä–æ–≤–µ–Ω—å ${pet.level}`;
            
            updateStatBar('healthBar', pet.health);
            updateStatBar('hungerBar', pet.hunger);
            updateStatBar('happinessBar', pet.happiness);
            updateStatBar('energyBar', pet.energy);
            
            document.getElementById('petId').textContent = `#${pet.petId}`;
            document.getElementById('petDna').textContent = pet.dna.toString().slice(0, 10) + '...';
            
            const rarityName = RARITY_NAMES[pet.rarity] || 'Common';
            const rarityStars = RARITY_STARS[pet.rarity] || '‚≠ê';
            document.getElementById('petRarity').textContent = `${rarityName} ${rarityStars}`;
            
            document.getElementById('petLevelInfo').textContent = pet.level;
            document.getElementById('petExp').textContent = pet.experience;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
            const closeBtn = document.getElementById('closeBtn');
            if (!pet.isAlive) {
                closeBtn.style.display = 'block';
                // –û—Ç–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                document.getElementById('feedBtn').disabled = true;
                document.getElementById('playBtn').disabled = true;
                document.getElementById('healBtn').disabled = true;
                document.getElementById('restBtn').disabled = true;
                showNotification("üíÄ –ü–∏—Ç–æ–º–µ—Ü –º–µ—Ä—Ç–≤! –ó–∞–∫—Ä–æ–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ.");
            } else {
                closeBtn.style.display = 'none';
                // –í–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                document.getElementById('feedBtn').disabled = false;
                document.getElementById('playBtn').disabled = false;
                document.getElementById('healBtn').disabled = false;
                document.getElementById('restBtn').disabled = false;
            }
        }

        function updateStatBar(id, value) {
            const bar = document.getElementById(id);
            bar.style.width = value + '%';
            bar.textContent = value + '%';
        }

        // ============================================================================
        // üî• –†–ï–ê–õ–¨–ù–û–ï –í–†–ï–ú–Ø DECAY (–ë–ï–ó –¢–†–ê–ù–ó–ê–ö–¶–ò–ô!)
        // ============================================================================

        // –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏
        function calculateVirtualStats(pet) {
            if (!pet) return null;
            
            const now = Date.now() / 1000; // —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            const timePassed = now - pet.lastDecayTime;
            
            // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ –º–∏–Ω—É—Ç—ã - –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ–º
            if (timePassed < 60) {
                return {
                    hunger: pet.hunger,
                    happiness: pet.happiness,
                    energy: pet.energy,
                    health: pet.health,
                    isAlive: pet.isAlive,
                    timePassed: timePassed
                };
            }
            
            // –°—á–∏—Ç–∞–µ–º decay —Ü–∏–∫–ª—ã
            const decayCycles = Math.floor(timePassed / 60);
            
            let virtualHunger = Math.max(0, pet.hunger - decayCycles);
            let virtualHappiness = Math.max(0, pet.happiness - Math.floor(decayCycles / 2));
            let virtualEnergy = Math.max(0, pet.energy - Math.floor(decayCycles / 3));
            let virtualHealth = pet.health;
            
            // –ï—Å–ª–∏ –≥–æ–ª–æ–¥ –∏–ª–∏ —Å—á–∞—Å—Ç—å–µ –∫—Ä–∏—Ç–∏—á–Ω–æ - –∑–¥–æ—Ä–æ–≤—å–µ –ø–∞–¥–∞–µ—Ç
            if (virtualHunger < 30 || virtualHappiness < 30) {
                virtualHealth = Math.max(0, virtualHealth - Math.floor(decayCycles / 2));
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–º–µ—Ä—Ç—å
            const virtualAlive = virtualHealth > 0;
            
            return {
                hunger: virtualHunger,
                happiness: virtualHappiness,
                energy: virtualEnergy,
                health: virtualHealth,
                isAlive: virtualAlive,
                timePassed: timePassed
            };
        }

        // –ü—Ä–æ–≥–Ω–æ–∑ —Å–º–µ—Ä—Ç–∏
        function predictDeath(pet) {
            if (!pet) return null;
            
            let virtualPet = { ...pet };
            let minutes = 0;
            
            // –°–∏–º—É–ª–∏—Ä—É–µ–º decay –¥–æ —Å–º–µ—Ä—Ç–∏
            while (virtualPet.health > 0 && minutes < 10000) {
                minutes++;
                
                virtualPet.hunger = Math.max(0, virtualPet.hunger - 1);
                virtualPet.happiness = Math.max(0, virtualPet.happiness - 0.5);
                virtualPet.energy = Math.max(0, virtualPet.energy - 0.33);
                
                if (virtualPet.hunger < 30 || virtualPet.happiness < 30) {
                    virtualPet.health = Math.max(0, virtualPet.health - 0.5);
                }
            }
            
            return minutes;
        }

        // –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        function getRecommendations(virtualStats) {
            const recommendations = [];
            
            if (virtualStats.hunger < 70) {
                recommendations.push({
                    action: 'üçñ –ö–æ—Ä–º–∏—Ç—å',
                    urgency: virtualStats.hunger < 30 ? 'critical' : 'medium',
                    cost: '5 TAMA'
                });
            }
            
            if (virtualStats.happiness < 70) {
                recommendations.push({
                    action: 'üéÆ –ò–≥—Ä–∞—Ç—å',
                    urgency: virtualStats.happiness < 30 ? 'critical' : 'medium',
                    cost: '3 TAMA'
                });
            }
            
            if (virtualStats.energy < 60) {
                recommendations.push({
                    action: 'üò¥ –û—Ç–¥–æ—Ö–Ω—É—Ç—å',
                    urgency: virtualStats.energy < 30 ? 'high' : 'low',
                    cost: '2 TAMA'
                });
            }
            
            if (virtualStats.health < 50) {
                recommendations.push({
                    action: 'üíä –õ–µ—á–∏—Ç—å',
                    urgency: 'critical',
                    cost: '8 TAMA'
                });
            }
            
            return recommendations;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function updateRealtimeUI() {
            if (!realPetData) return;
            
            // –ü–æ–ª—É—á–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—ã
            const virtualStats = calculateVirtualStats(realPetData);
            if (!virtualStats) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—ã
            updateStatBar('hungerBar', virtualStats.hunger);
            updateStatBar('happinessBar', virtualStats.happiness);
            updateStatBar('energyBar', virtualStats.energy);
            updateStatBar('healthBar', virtualStats.health);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø—Ä–∞–π—Ç –µ—Å–ª–∏ —É–º–µ—Ä
            if (!virtualStats.isAlive && realPetData.isAlive) {
                document.getElementById('petSprite').textContent = 'üíÄ';
                document.getElementById('petName').textContent = `üíÄ –ü–∏—Ç–æ–º–µ—Ü —É–º–µ—Ä #${realPetData.petId}`;
            }
            
            // –¢–∞–π–º–µ—Ä –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ decay
            const secondsToNextDecay = 60 - (virtualStats.timePassed % 60);
            document.getElementById('decayTimer').textContent = 
                `–°–ª–µ–¥—É—é—â–∏–π decay —á–µ—Ä–µ–∑: ${Math.floor(secondsToNextDecay)}—Å`;
            
            // –ü—Ä–æ–≥–Ω–æ–∑ —Å–º–µ—Ä—Ç–∏
            if (virtualStats.isAlive) {
                const deathMinutes = predictDeath(virtualStats);
                const deathPredEl = document.getElementById('deathPrediction');
                
                if (deathMinutes < 300) { // –ï—Å–ª–∏ –º–µ–Ω—å—à–µ 5 —á–∞—Å–æ–≤
                    const hours = Math.floor(deathMinutes / 60);
                    const mins = deathMinutes % 60;
                    deathPredEl.textContent = `üíÄ –£–º—Ä—ë—Ç —á–µ—Ä–µ–∑: ${hours > 0 ? hours + '—á ' : ''}${mins}–º`;
                    deathPredEl.style.display = 'block';
                } else {
                    deathPredEl.style.display = 'none';
                }
            } else {
                document.getElementById('deathPrediction').textContent = 'üíÄ –ü–∏—Ç–æ–º–µ—Ü –º–µ—Ä—Ç–≤';
                document.getElementById('deathPrediction').style.display = 'block';
            }
            
            // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            const recommendations = getRecommendations(virtualStats);
            const recEl = document.getElementById('recommendations');
            const recListEl = document.getElementById('recommendationsList');
            
            if (recommendations.length > 0) {
                recEl.style.display = 'block';
                
                let html = '';
                recommendations.forEach(rec => {
                    const urgencyColor = 
                        rec.urgency === 'critical' ? '#d32f2f' :
                        rec.urgency === 'high' ? '#f57c00' :
                        rec.urgency === 'medium' ? '#fbc02d' : '#689f38';
                    
                    html += `<div style="color: ${urgencyColor}; margin: 3px 0; text-align: center;">
                        ${rec.action} (${rec.cost})
                    </div>`;
                });
                
                recListEl.innerHTML = html;
            } else {
                recEl.style.display = 'none';
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function startRealtimeUpdates() {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
            if (realtimeUpdateInterval) {
                clearInterval(realtimeUpdateInterval);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É!
            realtimeUpdateInterval = setInterval(updateRealtimeUI, 1000);
            
            // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
            updateRealtimeUI();
            
            console.log('‚úÖ –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω–æ!');
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function stopRealtimeUpdates() {
            if (realtimeUpdateInterval) {
                clearInterval(realtimeUpdateInterval);
                realtimeUpdateInterval = null;
            }
        }

        // ============================================================================

        // –ö–ª–∏–∫ –ø–æ –ø–∏—Ç–æ–º—Ü—É
        function petClick() {
            const sprite = document.getElementById('petSprite');
            sprite.style.animation = 'none';
            setTimeout(() => {
                sprite.style.animation = 'float 3s ease-in-out infinite';
            }, 10);
            showNotification("‚ù§Ô∏è –ü–æ–≥–ª–∞–¥–∏–ª –ø–∏—Ç–æ–º—Ü–∞!");
        }

        // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        async function refreshPet() {
            if (!wallet || !petPubkey) return;
            
            try {
                const accountInfo = await connection.getAccountInfo(petPubkey);
                
                if (accountInfo && accountInfo.data) {
                    const pet = deserializePet(accountInfo.data);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    realPetData = pet;
                    
                    updateDisplay(pet);
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', err);
            }
        }

        // –ó–∞–∫—Ä—ã—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–∏—Ç–æ–º—Ü–∞ (–≤–µ—Ä–Ω—É—Ç—å rent)
        async function closePetAccount() {
            if (!wallet || !petPubkey) return;
            
            if (!confirm('üíÄ –ó–∞–∫—Ä—ã—Ç—å –∞–∫–∫–∞—É–Ω—Ç –ø–∏—Ç–æ–º—Ü–∞?\n\n‚úÖ Rent –±—É–¥–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω –Ω–∞ –∫–æ—à–µ–ª–µ–∫\n‚ö†Ô∏è –ü–∏—Ç–æ–º–µ—Ü –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞\n\n–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–∏—Ç–æ–º—Ü–∞.')) {
                return;
            }
            
            try {
                showNotification("üîÑ –ó–∞–∫—Ä—ã–≤–∞—é –∞–∫–∫–∞—É–Ω—Ç...");
                
                const programId = new window.solanaWeb3.PublicKey(PROGRAM_ID);
                const discriminator = await getInstructionDiscriminator('close_pet');
                
                const keys = [
                    { pubkey: petPubkey, isSigner: false, isWritable: true },
                    { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
                ];

                const instruction = new window.solanaWeb3.TransactionInstruction({
                    keys,
                    programId,
                    data: discriminator,
                });

                const transaction = new window.solanaWeb3.Transaction().add(instruction);
                transaction.feePayer = wallet.publicKey;
                transaction.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

                const signed = await wallet.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signed.serialize());
                
                await connection.confirmTransaction(signature, 'confirmed');
                
                console.log('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –∑–∞–∫—Ä—ã—Ç:', signature);
                showNotification("‚úÖ –ê–∫–∫–∞—É–Ω—Ç –∑–∞–∫—Ä—ã—Ç! Rent –≤–æ–∑–≤—Ä–∞—â–µ–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–∏—Ç–æ–º—Ü–∞!");
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω–∏—è
                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('createScreen').style.display = 'block';
                petPubkey = null;
                
            } catch (err) {
                showNotification("‚ùå –û—à–∏–±–∫–∞: " + err.message);
                console.error('–û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞:', err);
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ‚úÖ DECAY –¢–ï–ü–ï–†–¨ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô!
        // Decay –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (feed, play, heal, rest)
        // –ù–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –µ–≥–æ –æ—Ç–¥–µ–ª—å–Ω–æ!
        function startDecayTimer() {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π decay —Ç–µ–ø–µ—Ä—å –≤—Å—Ç—Ä–æ–µ–Ω –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç!
            console.log('‚úÖ Auto Decay –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ');
            console.log('‚è∞ Decay –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–π—Å—Ç–≤–∏–∏');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', async () => {
            await init();
            
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect({ onlyIfTrusted: true });
                    if (resp) {
                        await connectWallet();
                        startDecayTimer(); // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä
                    }
                } catch (e) {
                    console.log('–ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å');
                }
            }
        });
    </script>
</body>
</html>

